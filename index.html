<script>
    const analyzeBtn = document.getElementById('analyze-btn');
    const loader = document.getElementById('loader');
    const analysisOutput = document.getElementById('analysis-output');
    const assetSelect = document.getElementById('asset-select');
    
    // API Key ထည့်တဲ့ input field မလိုတော့ပါ
    // const apiKeyInput = document.getElementById('api-key-input');
    
    // API Key ထည့်တဲ့ HTML အပိုင်းကိုပါ ဖျက်လိုက်ပါ
    // <label for="api-key-input">...</label>
    // <input type="password" id="api-key-input" ...>

    analyzeBtn.addEventListener('click', getAnalysis);

    async function getAnalysis() {
        const selectedAsset = assetSelect.value;
        loader.style.display = 'block';
        analysisOutput.innerHTML = '';

        try {
            // Google API အစား ကိုယ့်ရဲ့ Vercel Function ကိုခေါ်ပါ
            const response = await fetch('/api/analyze', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ selectedAsset: selectedAsset }) // Asset ကို Backend ပို့ပေးပါ
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error || 'API request failed');
            }

            const data = await response.json();
            displayResults(data.result);

        } catch (error) {
            console.error("Error:", error);
            analysisOutput.innerHTML = `<div class="glass-card rounded-xl p-6 text-red-400">သုံးသပ်ချက်ရယူရာတွင် အမှားအယွင်းเกิดขึ้นပါသည်။<br>${error.message}</div>`;
        } finally {
            loader.style.display = 'none';
        }
    }

    function displayResults(text) {
        const summaryMatch = text.match(/### သတင်းအကျဉ်းချုပ်([\s\S]*?)###/);
        const calendarMatch = text.match(/### အရေးကြီးသော စီးပွားရေးသတင်းများ([\s\S]*?)###/);
        const sentimentMatch = text.match(/### ဈေးကွက်၏ ခံစားချက်([\s\S]*)/);

        let html = '';

        if (summaryMatch) {
            html += `<div class="output-card glass-card rounded-xl p-6"><h3>သတင်းအကျဉ်းချုပ်</h3><ul class="space-y-2 list-disc">${formatText(summaryMatch[1])}</ul></div>`;
        }
        if (calendarMatch) {
            html += `<div class="output-card glass-card rounded-xl p-6"><h3>အရေးကြီးသော စီးပွားရေးသတင်းများ</h3><div>${formatText(calendarMatch[1])}</div></div>`;
        }
        if (sentimentMatch) {
            html += `<div class="output-card glass-card rounded-xl p-6"><h3>ဈေးကွက်၏ ခံစားချက်</h3><div>${formatText(sentimentMatch[1])}</div></div>`;
        }
        
        analysisOutput.innerHTML = html;
    }

    function formatText(text) {
        return text
            .trim()
            .replace(/\*\*(.*?)\*\*/g, '<strong class="text-white">$1</strong>')
            .replace(/\* (.*?)/g, '<li>$1</li>')
            .replace(/^- (.*?)/gm, '<li>$1</li>')
            .replace(/\n/g, '<br>');
    }
</script>
